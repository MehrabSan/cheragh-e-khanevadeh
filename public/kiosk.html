<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Ø¯Ø³ØªÛŒØ§Ø± Ø³Ù„Ø§Ù…Øª Ùˆ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { vazir: ['Vazirmatn', 'sans-serif'] },
          colors: { slate: { 850: '#1a2332' } }
        }
      }
    }
  </script>
  <style>
    * {
      font-family: 'Vazirmatn', sans-serif !important;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
      box-sizing: border-box;
    }
    html, body { overflow: hidden; height: 100%; width: 100%; touch-action: manipulation; }
    #root { height: 100%; width: 100%; }
    .scroll-area { overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .scroll-area::-webkit-scrollbar { display: none; }
    .scroll-area { -ms-overflow-style: none; scrollbar-width: none; }
    input, textarea { user-select: text !important; -webkit-user-select: text !important; }

    /* Glassmorphism */
    .glass {
      background: rgba(255,255,255,0.65);
      backdrop-filter: blur(18px) saturate(180%);
      -webkit-backdrop-filter: blur(18px) saturate(180%);
      border: 1px solid rgba(255,255,255,0.35);
    }
    .dark .glass {
      background: rgba(30,41,59,0.7);
      border: 1px solid rgba(100,116,139,0.25);
    }

    /* Accordion */
    .accordion-enter { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.3s ease; }
    .accordion-open { max-height: 9999px; opacity: 1; overflow: visible; transition: max-height 0.5s cubic-bezier(0.4,0,0.2,1), opacity 0.35s ease; }

    .card-shadow { box-shadow: 0 4px 24px 0 rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.05); }
    .pulse-sos { animation: pulse-sos 1.8s infinite; }
    @keyframes pulse-sos {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
      50% { box-shadow: 0 0 0 16px rgba(239,68,68,0); }
    }
    .photo-ring { border: 3px solid rgba(226,232,240,0.8); }
    .dark .photo-ring { border-color: rgba(71,85,105,0.6); }

    /* Animations */
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(24px) scale(0.97); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: none; }
    }
    @keyframes modalIn {
      from { opacity: 0; transform: translateY(100%); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.92); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes checkPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.25); }
      100% { transform: scale(1); }
    }
    .fade-in { animation: fadeIn 0.35s ease-out; }
    .slide-up { animation: slideUp 0.4s cubic-bezier(0.4,0,0.2,1); }
    .modal-animate { animation: modalIn 0.35s cubic-bezier(0.22,1,0.36,1); }
    .scale-in { animation: scaleIn 0.3s cubic-bezier(0.22,1,0.36,1); }
    .check-pop { animation: checkPop 0.3s ease; }
    .modal-overlay {
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
  </style>
</head>
<body class="bg-slate-900">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

// â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const toPersian = (n) => {
  const d = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
  return String(n).replace(/[0-9]/g, c => d[c]);
};
const uid = () => Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
const fileToBase64 = (file) => new Promise((res, rej) => {
  const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file);
});

// â”€â”€â”€ Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LS_KEY = 'persian-contacts-v3';
const MED_KEY = 'persian-meds-v1';
const DM_KEY = 'persian-contacts-dark';
const ZOOM_KEY = 'persian-zoom';
const MED_DONE_KEY = 'persian-meds-done';

const load = (k, def) => { try { return JSON.parse(localStorage.getItem(k)) || def; } catch { return def; } };
const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

// â”€â”€â”€ Phone Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PHONE_TYPES = [
  { value: 'mobile1', label: 'Ù‡Ù…Ø±Ø§Ù‡ Û±', icon: 'phoneMobile' },
  { value: 'mobile2', label: 'Ù‡Ù…Ø±Ø§Ù‡ Û²', icon: 'phoneMobile2' },
  { value: 'home', label: 'ØªÙ„ÙÙ† Ù…Ù†Ø²Ù„', icon: 'phoneHome' },
  { value: 'work', label: 'ØªÙ„ÙÙ† Ù…Ø­Ù„ Ú©Ø§Ø±', icon: 'phoneWork' },
];
const getPhoneType = (t) => PHONE_TYPES.find(p => p.value === t) || PHONE_TYPES[0];

// â”€â”€â”€ Migration from old format â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const migrateContact = (c) => {
  if (c.phones) return c;
  const phones = c.phone ? [{ id: uid(), type: 'mobile1', number: c.phone }] : [];
  const migrated = { ...c, phones };
  delete migrated.phone;
  if (migrated.subContacts) {
    migrated.subContacts = migrated.subContacts.map(migrateContact);
  }
  return migrated;
};
const loadContacts = () => {
  // Try v3 first, then v2
  let data = load('persian-contacts-v3', null);
  if (!data) data = load('persian-contacts-v2', null);
  if (!data) data = load(LS_KEY, []);
  return (data || []).map(migrateContact);
};

// â”€â”€â”€ Share â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const shareContact = async (name, phones) => {
  const phoneLines = (phones || []).map(p => `${getPhoneType(p.type).label}: ${p.number}`).join('\n');
  const text = `${name}\n${phoneLines}`;
  if (navigator.share) { try { await navigator.share({ title: name, text }); } catch {} }
  else { try { await navigator.clipboard.writeText(text); alert('Ú©Ù¾ÛŒ Ø´Ø¯'); } catch {} }
};

// â”€â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const matchesSearch = (c, q) => {
  if (!q) return true;
  const ql = q.toLowerCase();
  if (c.name?.toLowerCase().includes(ql)) return true;
  if (c.phones) { for (const p of c.phones) { if (p.number?.includes(q)) return true; } }
  if (c.phone?.includes(q)) return true;
  return false;
};
const familyMatchesSearch = (f, q) => {
  if (!q) return true;
  if (matchesSearch(f, q)) return true;
  for (const ch of (f.subContacts || [])) {
    if (matchesSearch(ch, q)) return true;
    for (const gc of (ch.subContacts || [])) { if (matchesSearch(gc, q)) return true; }
  }
  return false;
};

// â”€â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const exportData = (contacts, meds) => {
  const data = { contacts, medications: meds, exportDate: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `family-health-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
};

// â”€â”€â”€ Today key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const todayKey = () => new Date().toISOString().slice(0, 10);

// â”€â”€â”€ Icons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Icon = ({ name, size = 20, color = 'currentColor', className = '' }) => {
  const s = { width: size, height: size };
  const p = { fill: 'none', stroke: color, strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' };
  const icons = {
    phone: <svg {...s} viewBox="0 0 24 24" {...p} strokeWidth="2.5" className={className}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.62 3.47A2 2 0 0 1 3.6 1.25h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.96a16 16 0 0 0 6.29 6.29l.93-.93a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
    camera: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
    chevronDown: <svg {...s} viewBox="0 0 24 24" {...p} strokeWidth="2.5" className={className}><polyline points="6 9 12 15 18 9"/></svg>,
    chevronUp: <svg {...s} viewBox="0 0 24 24" {...p} strokeWidth="2.5" className={className}><polyline points="18 15 12 9 6 15"/></svg>,
    plus: <svg {...s} viewBox="0 0 24 24" {...p} strokeWidth="2.5" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    userPlus: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
    trash: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>,
    edit: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
    alertCircle: <svg {...s} viewBox="0 0 24 24" {...p} strokeWidth="2.5" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
    share: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
    search: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
    sun: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
    moon: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
    close: <svg {...s} viewBox="0 0 24 24" {...p} strokeWidth="2.5" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
    signal: <svg {...s} viewBox="0 0 24 24" fill={color} className={className}><rect x="1" y="16" width="4" height="7" rx="1"/><rect x="7" y="11" width="4" height="12" rx="1"/><rect x="13" y="6" width="4" height="17" rx="1" opacity=".7"/><rect x="19" y="1" width="4" height="22" rx="1" opacity=".4"/></svg>,
    wifi: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><circle cx="12" cy="20" r="1" fill={color}/></svg>,
    pill: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><path d="M10.5 1.5l-8 8a5.66 5.66 0 0 0 8 8l8-8a5.66 5.66 0 0 0-8-8z"/><line x1="6" y1="14" x2="14" y2="6"/></svg>,
    syrup: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><rect x="6" y="8" width="12" height="14" rx="2"/><path d="M9 8V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3"/><line x1="12" y1="12" x2="12" y2="18"/><line x1="9" y1="15" x2="15" y2="15"/></svg>,
    injection: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><path d="M18 2l4 4"/><path d="M17.4 6.6l-9.8 9.8"/><path d="M7.6 16.4l-4.2 4.2"/><path d="M15 9l-6 6"/><path d="M11 5l8 8"/></svg>,
    check: <svg {...s} viewBox="0 0 24 24" {...p} strokeWidth="3" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
    download: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
    zoomIn: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
    zoomOut: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
    contacts: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
    phoneMobile: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><rect x="5" y="2" width="14" height="20" rx="3"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>,
    phoneMobile2: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><rect x="2" y="2" width="11" height="20" rx="2.5"/><rect x="11" y="4" width="11" height="16" rx="2.5" opacity="0.5"/><circle cx="7.5" cy="18" r="0.8" fill={color}/></svg>,
    phoneHome: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
    phoneWork: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/><line x1="12" y1="12" x2="12" y2="12.01"/></svg>,
    medicine: <svg {...s} viewBox="0 0 24 24" {...p} className={className}><rect x="3" y="3" width="18" height="18" rx="3"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>,
  };
  return icons[name] || null;
};

const BatteryIcon = ({ level, charging }) => {
  const fill = charging ? '#22c55e' : level > 20 ? '#94a3b8' : '#ef4444';
  const w = Math.max(0, Math.min(100, level));
  return (
    <svg width="26" height="14" viewBox="0 0 26 14" fill="none">
      <rect x="0.5" y="0.5" width="22" height="13" rx="2.5" stroke={fill} strokeWidth="1.2"/>
      <rect x="2" y="2" width={w * 0.18} height="10" rx="1.5" fill={fill}/>
      <rect x="23" y="4" width="2.5" height="6" rx="1.2" fill={fill} opacity="0.7"/>
      {charging && <text x="11" y="10.5" textAnchor="middle" fontSize="9" fill="#22c55e" fontWeight="bold">âš¡</text>}
    </svg>
  );
};

// â”€â”€â”€ Status Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const StatusBar = () => {
  const [time, setTime] = useState('');
  const [battery, setBattery] = useState({ level: 100, charging: false });
  useEffect(() => {
    const tick = () => { const n = new Date(); setTime(toPersian(`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`)); };
    tick(); const id = setInterval(tick, 1000); return () => clearInterval(id);
  }, []);
  useEffect(() => {
    if ('getBattery' in navigator) {
      navigator.getBattery().then(b => {
        const u = () => setBattery({ level: Math.round(b.level*100), charging: b.charging });
        u(); b.addEventListener('levelchange', u); b.addEventListener('chargingchange', u);
      }).catch(() => {});
    }
  }, []);
  return (
    <div className="flex items-center justify-between px-4 py-1 bg-slate-800/90 text-slate-300 text-xs backdrop-blur-sm" style={{minHeight:28}}>
      <div className="flex items-center gap-2"><Icon name="signal" size={14} color="#94a3b8"/><Icon name="wifi" size={14} color="#94a3b8"/></div>
      <span className="font-bold text-sm tracking-wider">{time}</span>
      <div className="flex items-center gap-1.5"><span style={{fontSize:11}}>{toPersian(battery.level)}Ùª</span><BatteryIcon level={battery.level} charging={battery.charging}/></div>
    </div>
  );
};

// â”€â”€â”€ Name Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ContactModal = ({ open, initial, onSave, onClose }) => {
  const [name, setName] = useState('');
  useEffect(() => { if (open) { setName(initial?.name || ''); } }, [open, initial]);
  if (!open) return null;
  const handleSave = () => { if (!name.trim()) return; onSave({ name: name.trim() }); onClose(); };
  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center modal-overlay" style={{background:'rgba(15,23,42,0.6)'}}>
      <div className="w-full max-w-lg glass rounded-t-3xl p-6 modal-animate" style={{paddingBottom:'max(1.5rem, env(safe-area-inset-bottom))'}}>
        <div className="w-12 h-1.5 bg-slate-300 dark:bg-slate-600 rounded-full mx-auto mb-5"/>
        <h2 className="text-xl font-bold text-slate-800 dark:text-slate-100 mb-5 text-center">{initial ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù…' : 'Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø®Ø§Ø·Ø¨'}</h2>
        <div>
          <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1.5">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
          <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ"
            className="w-full border-2 border-slate-200/60 dark:border-slate-600/60 rounded-2xl px-4 py-3 text-slate-800 dark:text-slate-100 bg-white/80 dark:bg-slate-700/80 text-base focus:outline-none focus:border-blue-400 transition-colors backdrop-blur-sm"
            style={{userSelect:'text', WebkitUserSelect:'text'}} autoFocus />
        </div>
        <div className="flex gap-3 mt-6">
          <button onClick={onClose} className="flex-1 py-3.5 rounded-2xl bg-slate-100/80 dark:bg-slate-700/80 text-slate-600 dark:text-slate-300 font-semibold text-base active:bg-slate-200 transition-colors backdrop-blur-sm">Ø§Ù†ØµØ±Ø§Ù</button>
          <button onClick={handleSave} disabled={!name.trim()} className="flex-1 py-3.5 rounded-2xl bg-blue-500 text-white font-bold text-base active:bg-blue-600 transition-colors disabled:opacity-40">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
      </div>
    </div>
  );
};

// â”€â”€â”€ Phone Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PhoneModal = ({ open, initial, onSave, onClose }) => {
  const [number, setNumber] = useState('');
  const [type, setType] = useState('mobile1');
  useEffect(() => { if (open) { setNumber(initial?.number || ''); setType(initial?.type || 'mobile1'); } }, [open, initial]);
  if (!open) return null;
  const handleSave = () => { if (!number.trim()) return; onSave({ number: number.trim(), type }); onClose(); };
  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center modal-overlay" style={{background:'rgba(15,23,42,0.6)'}}>
      <div className="w-full max-w-lg glass rounded-t-3xl p-6 modal-animate" style={{paddingBottom:'max(1.5rem, env(safe-area-inset-bottom))'}}>
        <div className="w-12 h-1.5 bg-slate-300 dark:bg-slate-600 rounded-full mx-auto mb-5"/>
        <h2 className="text-xl font-bold text-slate-800 dark:text-slate-100 mb-5 text-center">{initial ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù‡' : 'Ø§ÙØ²ÙˆØ¯Ù† Ø´Ù…Ø§Ø±Ù‡ Ø¬Ø¯ÛŒØ¯'}</h2>
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-2">Ù†ÙˆØ¹ Ø´Ù…Ø§Ø±Ù‡</label>
            <div className="grid grid-cols-2 gap-2">
              {PHONE_TYPES.map(pt => (
                <button key={pt.value} onClick={() => setType(pt.value)}
                  className={`flex items-center gap-2.5 px-3 py-3 rounded-2xl border-2 font-semibold text-sm transition-all ${type === pt.value ? 'bg-blue-50/80 dark:bg-blue-900/30 border-blue-400 dark:border-blue-600 text-blue-700 dark:text-blue-300' : 'bg-white/60 dark:bg-slate-700/60 border-slate-200/60 dark:border-slate-600/40 text-slate-600 dark:text-slate-400'}`}>
                  <Icon name={pt.icon} size={24} color={type === pt.value ? '#3b82f6' : '#94a3b8'}/>
                  {pt.label}
                </button>
              ))}
            </div>
          </div>
          <div>
            <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1.5">Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</label>
            <input type="tel" inputMode="numeric" pattern="[0-9]*" value={number} onChange={e => setNumber(e.target.value)} placeholder="Ù…Ø«Ø§Ù„: Û°Û¹Û±Û²Û±Û²Û³Û´ÛµÛ¶Û·"
              className="w-full border-2 border-slate-200/60 dark:border-slate-600/60 rounded-2xl px-4 py-3 text-slate-800 dark:text-slate-100 bg-white/80 dark:bg-slate-700/80 text-lg focus:outline-none focus:border-blue-400 transition-colors backdrop-blur-sm"
              style={{userSelect:'text', WebkitUserSelect:'text', direction:'ltr', textAlign:'right'}} autoFocus />
          </div>
        </div>
        <div className="flex gap-3 mt-6">
          <button onClick={onClose} className="flex-1 py-3.5 rounded-2xl bg-slate-100/80 dark:bg-slate-700/80 text-slate-600 dark:text-slate-300 font-semibold text-base active:bg-slate-200 transition-colors backdrop-blur-sm">Ø§Ù†ØµØ±Ø§Ù</button>
          <button onClick={handleSave} disabled={!number.trim()} className="flex-1 py-3.5 rounded-2xl bg-blue-500 text-white font-bold text-base active:bg-blue-600 transition-colors disabled:opacity-40">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
      </div>
    </div>
  );
};

// â”€â”€â”€ Phone List Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PhoneList = ({ phones = [], onAdd, onEdit, onDelete }) => (
  <div className="space-y-2">
    {phones.map(p => {
      const pt = getPhoneType(p.type);
      return (
        <div key={p.id} className="flex items-center gap-2 glass rounded-2xl p-2.5 card-shadow fade-in">
          <div className="w-11 h-11 rounded-xl bg-emerald-50/80 dark:bg-emerald-900/20 flex items-center justify-center flex-shrink-0">
            <Icon name={pt.icon} size={22} color="#10b981"/>
          </div>
          <div className="flex-1 min-w-0">
            <p className="text-xs font-semibold text-slate-500 dark:text-slate-400">{pt.label}</p>
            <a href={`tel:${p.number}`} onClick={e => e.stopPropagation()} className="text-slate-800 dark:text-slate-100 font-bold text-base font-mono block truncate" style={{direction:'ltr', textAlign:'right'}}>{toPersian(p.number)}</a>
          </div>
          <div className="flex gap-1.5 flex-shrink-0">
            <a href={`tel:${p.number}`} onClick={e => e.stopPropagation()} className="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center active:bg-emerald-600 shadow-sm"><Icon name="phone" size={18} color="white"/></a>
            <button onClick={e => { e.stopPropagation(); onEdit(p); }} className="w-10 h-10 bg-blue-50/80 dark:bg-blue-900/30 rounded-xl flex items-center justify-center active:bg-blue-100 backdrop-blur-sm"><Icon name="edit" size={16} color="#3b82f6"/></button>
            <button onClick={e => { e.stopPropagation(); onDelete(p.id); }} className="w-10 h-10 bg-red-50/80 dark:bg-red-900/30 rounded-xl flex items-center justify-center active:bg-red-100 backdrop-blur-sm"><Icon name="trash" size={16} color="#ef4444"/></button>
          </div>
        </div>
      );
    })}
    <button onClick={e => { e.stopPropagation(); onAdd(); }}
      className="w-full flex items-center justify-center gap-2 py-3 glass rounded-2xl text-blue-600 dark:text-blue-400 font-bold text-sm active:bg-blue-50/50 card-shadow">
      <Icon name="plus" size={18} color="#3b82f6"/> Ø§ÙØ²ÙˆØ¯Ù† Ø´Ù…Ø§Ø±Ù‡ Ø¬Ø¯ÛŒØ¯
    </button>
  </div>
);

// â”€â”€â”€ Confirm Dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ConfirmDialog = ({ open, message, onConfirm, onCancel }) => {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-6" style={{background:'rgba(15,23,42,0.6)'}}>
      <div className="w-full max-w-sm glass rounded-3xl p-6 scale-in">
        <div className="flex justify-center mb-4"><Icon name="alertCircle" size={44} color="#ef4444"/></div>
        <p className="text-slate-700 dark:text-slate-200 font-semibold text-center text-base mb-6">{message}</p>
        <div className="flex gap-3">
          <button onClick={onCancel} className="flex-1 py-3 rounded-2xl bg-slate-100/80 dark:bg-slate-700/80 text-slate-600 dark:text-slate-300 font-semibold active:bg-slate-200 backdrop-blur-sm">Ù†Ù‡</button>
          <button onClick={onConfirm} className="flex-1 py-3 rounded-2xl bg-red-500 text-white font-bold active:bg-red-600">Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ø´ÙˆØ¯</button>
        </div>
      </div>
    </div>
  );
};

// â”€â”€â”€ Photo Uploader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PhotoUploader = ({ image, name, size = 80, onUpload }) => {
  const ref = useRef();
  const initials = name ? name.trim().split(' ').map(w=>w[0]).slice(0,2).join('') : 'ØŸ';
  const handleChange = async (e) => {
    const f = e.target.files?.[0]; if (!f) return;
    try { onUpload(await fileToBase64(f)); } catch {} e.target.value = '';
  };
  return (
    <div className="relative flex-shrink-0" style={{width:size, height:size}} onClick={e => e.stopPropagation()}>
      <button onClick={() => ref.current?.click()} className="w-full h-full rounded-full overflow-hidden photo-ring focus:outline-none active:opacity-80 transition-opacity" style={{width:size, height:size}}>
        {image ? <img src={image} alt={name} className="w-full h-full object-cover" draggable={false}/> :
          <div className="w-full h-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center"><span className="text-white font-bold" style={{fontSize:size*0.3}}>{initials}</span></div>}
      </button>
      <button onClick={() => ref.current?.click()} className="absolute bottom-0 left-0 bg-blue-500 rounded-full flex items-center justify-center shadow-lg active:bg-blue-600"
        style={{width:Math.round(size*0.36), height:Math.round(size*0.36)}}><Icon name="camera" size={Math.round(size*0.2)} color="white"/></button>
      <input ref={ref} type="file" accept="image/*" capture="environment" className="hidden" onChange={handleChange}/>
    </div>
  );
};

// â”€â”€â”€ Share Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ShareButton = ({ name, phones, size = 'md' }) => {
  if (!phones || phones.length === 0) return null;
  const s = size === 'sm' ? 9 : 10;
  return (
    <button onClick={e => { e.stopPropagation(); shareContact(name, phones); }}
      className={`w-${s} h-${s} bg-violet-50/80 dark:bg-violet-900/30 rounded-xl flex items-center justify-center active:bg-violet-100 backdrop-blur-sm`}
      aria-label="Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ"><Icon name="share" size={size === 'sm' ? 14 : 18} color="#7c3aed"/></button>
  );
};

// â”€â”€â”€ Level 3 Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Level3Card = ({ contact, onUpdate, onEdit, onDelete }) => {
  const [phoneModal, setPhoneModal] = useState(null);
  const [confirmPhone, setConfirmPhone] = useState(null);
  const [expanded, setExpanded] = useState(false);
  const phones = contact.phones || [];
  const primaryPhone = phones[0];
  const addPhone = (d) => onUpdate({ ...contact, phones: [...phones, { id: uid(), ...d }] });
  const editPhone = (pId, d) => onUpdate({ ...contact, phones: phones.map(p => p.id === pId ? { ...p, ...d } : p) });
  const deletePhone = (pId) => onUpdate({ ...contact, phones: phones.filter(p => p.id !== pId) });

  return (
    <div className="glass rounded-2xl card-shadow slide-up overflow-hidden">
      <div className="flex items-center gap-3 p-3 cursor-pointer active:bg-white/40 dark:active:bg-slate-600/40 transition-colors" onClick={() => setExpanded(o => !o)}>
        <PhotoUploader image={contact.image} name={contact.name} size={52} onUpload={b64 => onUpdate({...contact, image: b64})}/>
        <div className="flex-1 min-w-0">
          <p className="font-semibold text-slate-800 dark:text-slate-100 text-sm truncate">{contact.name}</p>
          {phones.length > 0 && <p className="text-slate-400 dark:text-slate-500 text-xs">{toPersian(phones.length)} Ø´Ù…Ø§Ø±Ù‡</p>}
        </div>
        <div className="flex gap-2 flex-shrink-0">
          <ShareButton name={contact.name} phones={phones} size="sm"/>
          {primaryPhone && <a href={`tel:${primaryPhone.number}`} onClick={e => e.stopPropagation()} className="w-9 h-9 bg-emerald-500 rounded-xl flex items-center justify-center active:bg-emerald-600 shadow-sm"><Icon name="phone" size={16} color="white"/></a>}
          <button onClick={e => { e.stopPropagation(); onEdit(); }} className="w-9 h-9 bg-blue-50/80 dark:bg-blue-900/30 rounded-xl flex items-center justify-center active:bg-blue-100 backdrop-blur-sm"><Icon name="edit" size={16} color="#3b82f6"/></button>
          <button onClick={e => { e.stopPropagation(); onDelete(); }} className="w-9 h-9 bg-red-50/80 dark:bg-red-900/30 rounded-xl flex items-center justify-center active:bg-red-100 backdrop-blur-sm"><Icon name="trash" size={16} color="#ef4444"/></button>
          {expanded ? <Icon name="chevronUp" size={16} color="#94a3b8"/> : <Icon name="chevronDown" size={16} color="#94a3b8"/>}
        </div>
      </div>
      <div className={expanded ? 'accordion-open' : 'accordion-enter'}>
        {expanded && (
          <div className="px-3 pb-3">
            <PhoneList phones={phones}
              onAdd={() => setPhoneModal({ type: 'add' })}
              onEdit={p => setPhoneModal({ type: 'edit', phone: p })}
              onDelete={pId => setConfirmPhone(pId)}
            />
          </div>
        )}
      </div>
      <PhoneModal open={phoneModal?.type === 'add'} initial={null} onSave={d => addPhone(d)} onClose={() => setPhoneModal(null)}/>
      <PhoneModal open={phoneModal?.type === 'edit'} initial={phoneModal?.phone} onSave={d => editPhone(phoneModal.phone.id, d)} onClose={() => setPhoneModal(null)}/>
      <ConfirmDialog open={!!confirmPhone} message="Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ" onConfirm={() => { deletePhone(confirmPhone); setConfirmPhone(null); }} onCancel={() => setConfirmPhone(null)}/>
    </div>
  );
};

// â”€â”€â”€ Level 2 Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Level2Card = ({ contact, onUpdate, onEdit, onDelete, onAddChild, onUpdateChild, onDeleteChild, forceOpen }) => {
  const [open, setOpen] = useState(false);
  const [modal, setModal] = useState(null);
  const [phoneModal, setPhoneModal] = useState(null);
  const [confirm, setConfirm] = useState(null);
  const [confirmPhone, setConfirmPhone] = useState(null);
  useEffect(() => { if (forceOpen) setOpen(true); }, [forceOpen]);
  const phones = contact.phones || [];
  const primaryPhone = phones[0];
  const addPhone = (d) => onUpdate({ ...contact, phones: [...phones, { id: uid(), ...d }] });
  const editPhone = (pId, d) => onUpdate({ ...contact, phones: phones.map(p => p.id === pId ? { ...p, ...d } : p) });
  const deletePhone = (pId) => onUpdate({ ...contact, phones: phones.filter(p => p.id !== pId) });

  return (
    <div className="rounded-2xl glass overflow-hidden slide-up card-shadow">
      <div className="flex items-center gap-3 p-3 cursor-pointer active:bg-white/40 dark:active:bg-slate-600/40 transition-colors" onClick={() => setOpen(o => !o)}>
        <PhotoUploader image={contact.image} name={contact.name} size={58} onUpload={b64 => onUpdate({...contact, image: b64})}/>
        <div className="flex-1 min-w-0">
          <p className="font-bold text-slate-800 dark:text-slate-100 truncate">{contact.name}</p>
        </div>
        <div className="flex items-center gap-2 flex-shrink-0">
          <ShareButton name={contact.name} phones={phones}/>
          {primaryPhone && <a href={`tel:${primaryPhone.number}`} onClick={e => e.stopPropagation()} className="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center active:bg-emerald-600 shadow-sm"><Icon name="phone" size={18} color="white"/></a>}
          {open ? <Icon name="chevronUp" size={20} color="#94a3b8"/> : <Icon name="chevronDown" size={20} color="#94a3b8"/>}
        </div>
      </div>
      <div className={open ? 'accordion-open' : 'accordion-enter'}>
        {open && (
          <div className="px-3 pb-3 space-y-3">
            {/* Phones */}
            <PhoneList phones={phones}
              onAdd={() => setPhoneModal({ type: 'add' })}
              onEdit={p => setPhoneModal({ type: 'edit', phone: p })}
              onDelete={pId => setConfirmPhone(pId)}
            />
            {/* Toolbar */}
            <div className="flex gap-2 flex-wrap pt-1">
              <button onClick={e => { e.stopPropagation(); setModal({type:'add-l3'}); }} className="flex items-center gap-1.5 px-3 py-2 bg-indigo-50/80 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 rounded-xl text-xs font-semibold active:bg-indigo-100 backdrop-blur-sm"><Icon name="userPlus" size={14} color="#4f46e5"/> Ø§ÙØ²ÙˆØ¯Ù† Ù†ÙˆÙ‡/Ù‡Ù…Ø³Ø±</button>
              <button onClick={e => { e.stopPropagation(); setModal({type:'edit', initial: contact}); }} className="flex items-center gap-1.5 px-3 py-2 bg-blue-50/80 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 rounded-xl text-xs font-semibold active:bg-blue-100 backdrop-blur-sm"><Icon name="edit" size={14} color="#3b82f6"/> ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù…</button>
              <button onClick={e => { e.stopPropagation(); setConfirm(true); }} className="flex items-center gap-1.5 px-3 py-2 bg-red-50/80 dark:bg-red-900/30 text-red-500 dark:text-red-300 rounded-xl text-xs font-semibold active:bg-red-100 backdrop-blur-sm"><Icon name="trash" size={14} color="#ef4444"/> Ø­Ø°Ù</button>
            </div>
            {contact.subContacts?.length > 0 ? (
              <div className="space-y-2">{contact.subContacts.map(ch => <Level3Card key={ch.id} contact={ch} onUpdate={updated => onUpdateChild(ch.id, updated)} onEdit={() => setModal({type:'edit-l3', child:ch})} onDelete={() => setConfirm({childId:ch.id})}/>)}</div>
            ) : <p className="text-slate-400 dark:text-slate-500 text-xs text-center py-2">Ù‡Ù…Ø³Ø± / Ù†ÙˆÙ‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p>}
          </div>
        )}
      </div>
      <ContactModal open={modal?.type==='add-l3'} initial={null} onSave={d => onAddChild({id:uid(), name:d.name, phones:[], image:null, subContacts:[]})} onClose={() => setModal(null)}/>
      <ContactModal open={modal?.type==='edit'} initial={modal?.initial} onSave={d => onEdit(d)} onClose={() => setModal(null)}/>
      <ContactModal open={modal?.type==='edit-l3'} initial={modal?.child} onSave={d => onUpdateChild(modal.child.id, {...modal.child, ...d})} onClose={() => setModal(null)}/>
      <PhoneModal open={phoneModal?.type === 'add'} initial={null} onSave={d => addPhone(d)} onClose={() => setPhoneModal(null)}/>
      <PhoneModal open={phoneModal?.type === 'edit'} initial={phoneModal?.phone} onSave={d => editPhone(phoneModal.phone.id, d)} onClose={() => setPhoneModal(null)}/>
      <ConfirmDialog open={!!confirmPhone} message="Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ" onConfirm={() => { deletePhone(confirmPhone); setConfirmPhone(null); }} onCancel={() => setConfirmPhone(null)}/>
      <ConfirmDialog open={confirm === true || confirm?.childId} message={confirm?.childId ? 'Ø§ÛŒÙ† Ù…Ø®Ø§Ø·Ø¨ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ' : 'Ø§ÛŒÙ† ÙØ±Ø²Ù†Ø¯ Ùˆ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒÙ‡Ø§ÛŒØ´ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ'} onConfirm={() => { if (confirm?.childId) onDeleteChild(confirm.childId); else onDelete(); setConfirm(null); }} onCancel={() => setConfirm(null)}/>
    </div>
  );
};

// â”€â”€â”€ Level 1 Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Level1Card = ({ contact, onChange, onDelete, forceOpen, searchQuery }) => {
  const [open, setOpen] = useState(false);
  const [modal, setModal] = useState(null);
  const [phoneModal, setPhoneModal] = useState(null);
  const [confirm, setConfirm] = useState(false);
  const [confirmPhone, setConfirmPhone] = useState(null);
  useEffect(() => { if (forceOpen) setOpen(true); }, [forceOpen]);
  const update = (p) => onChange({...contact, ...p});
  const phones = contact.phones || [];
  const primaryPhone = phones[0];
  const addPhone = (d) => update({ phones: [...phones, { id: uid(), ...d }] });
  const editPhone = (pId, d) => update({ phones: phones.map(p => p.id === pId ? { ...p, ...d } : p) });
  const deletePhone = (pId) => update({ phones: phones.filter(p => p.id !== pId) });
  const addChild = (ch) => update({subContacts:[...(contact.subContacts||[]), ch]});
  const updateChild = (id, p) => update({subContacts:(contact.subContacts||[]).map(c => c.id===id ? p : c)});
  const deleteChild = (id) => update({subContacts:(contact.subContacts||[]).filter(c => c.id!==id)});
  const updateGrandchild = (cId, gId, p) => { const ch = contact.subContacts?.find(c=>c.id===cId); if(!ch) return; updateChild(cId, {...ch, subContacts:(ch.subContacts||[]).map(g=>g.id===gId?p:g)}); };
  const deleteGrandchild = (cId, gId) => { const ch = contact.subContacts?.find(c=>c.id===cId); if(!ch) return; updateChild(cId, {...ch, subContacts:(ch.subContacts||[]).filter(g=>g.id!==gId)}); };
  const addGrandchild = (cId, gc) => { const ch = contact.subContacts?.find(c=>c.id===cId); if(!ch) return; updateChild(cId, {...ch, subContacts:[...(ch.subContacts||[]), gc]}); };
  const childForceOpen = (ch) => { if(!searchQuery) return false; for(const gc of (ch.subContacts||[])) { if(matchesSearch(gc, searchQuery)) return true; } return false; };

  return (
    <div className="glass rounded-3xl card-shadow overflow-hidden slide-up">
      <div className="flex items-center gap-4 p-4 cursor-pointer active:bg-white/40 dark:active:bg-slate-700/40 transition-colors" onClick={() => setOpen(o => !o)}>
        <PhotoUploader image={contact.image} name={contact.name} size={78} onUpload={b64 => update({image:b64})}/>
        <div className="flex-1 min-w-0">
          <h2 className="font-extrabold text-slate-800 dark:text-slate-100 text-lg truncate leading-tight">{contact.name}</h2>
          <p className="text-slate-400 dark:text-slate-500 text-xs mt-1">{contact.subContacts?.length > 0 ? `${toPersian(contact.subContacts.length)} ÙØ±Ø²Ù†Ø¯` : 'ÙØ±Ø²Ù†Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡'}</p>
        </div>
        <div className="flex flex-col items-center gap-2 flex-shrink-0">
          <div className="flex items-center gap-2">
            <ShareButton name={contact.name} phones={phones}/>
            {primaryPhone && <a href={`tel:${primaryPhone.number}`} onClick={e => e.stopPropagation()} className="w-14 h-14 bg-emerald-500 rounded-2xl flex items-center justify-center active:bg-emerald-600 shadow-md"><Icon name="phone" size={24} color="white"/></a>}
          </div>
          {open ? <Icon name="chevronUp" size={22} color="#94a3b8"/> : <Icon name="chevronDown" size={22} color="#94a3b8"/>}
        </div>
      </div>
      <div className={open ? 'accordion-open' : 'accordion-enter'}>
        {open && (
          <div className="px-4 pb-4 space-y-3 border-t border-slate-200/40 dark:border-slate-700/40 pt-3">
            {/* Phone List */}
            <PhoneList phones={phones}
              onAdd={() => setPhoneModal({ type: 'add' })}
              onEdit={p => setPhoneModal({ type: 'edit', phone: p })}
              onDelete={pId => setConfirmPhone(pId)}
            />
            {/* Toolbar */}
            <div className="flex gap-2 flex-wrap">
              <button onClick={() => setModal({type:'add-child'})} className="flex items-center gap-1.5 px-3 py-2.5 bg-indigo-500 text-white rounded-xl text-sm font-semibold active:bg-indigo-600 shadow-sm"><Icon name="userPlus" size={16} color="white"/> Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ø²Ù†Ø¯</button>
              <button onClick={() => setModal({type:'edit', initial:contact})} className="flex items-center gap-1.5 px-3 py-2.5 bg-blue-50/80 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 rounded-xl text-sm font-semibold active:bg-blue-100 backdrop-blur-sm"><Icon name="edit" size={16} color="#3b82f6"/> ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù…</button>
              <button onClick={() => setConfirm(true)} className="flex items-center gap-1.5 px-3 py-2.5 bg-red-50/80 dark:bg-red-900/30 text-red-500 dark:text-red-300 rounded-xl text-sm font-semibold active:bg-red-100 backdrop-blur-sm"><Icon name="trash" size={16} color="#ef4444"/> Ø­Ø°Ù Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡</button>
            </div>
            {/* Children */}
            {contact.subContacts?.length > 0 ? (
              <div className="space-y-2">{contact.subContacts.map(ch => <Level2Card key={ch.id} contact={ch} forceOpen={childForceOpen(ch)} onUpdate={updated => updateChild(ch.id, updated)} onEdit={d => updateChild(ch.id, {...ch, ...d})} onDelete={() => deleteChild(ch.id)} onAddChild={gc => addGrandchild(ch.id, gc)} onUpdateChild={(gId, p) => updateGrandchild(ch.id, gId, p)} onDeleteChild={gId => deleteGrandchild(ch.id, gId)}/>)}</div>
            ) : (
              <div className="py-4 text-center"><p className="text-slate-400 dark:text-slate-500 text-sm">Ù‡Ù†ÙˆØ² ÙØ±Ø²Ù†Ø¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡</p><button onClick={() => setModal({type:'add-child'})} className="mt-2 text-indigo-500 text-sm font-semibold">+ Ø§ÙØ²ÙˆØ¯Ù† Ø§ÙˆÙ„ÛŒÙ† ÙØ±Ø²Ù†Ø¯</button></div>
            )}
          </div>
        )}
      </div>
      <ContactModal open={modal?.type==='add-child'} initial={null} onSave={d => addChild({id:uid(), name:d.name, phones:[], image:null, subContacts:[]})} onClose={() => setModal(null)}/>
      <ContactModal open={modal?.type==='edit'} initial={modal?.initial} onSave={d => update(d)} onClose={() => setModal(null)}/>
      <PhoneModal open={phoneModal?.type === 'add'} initial={null} onSave={d => addPhone(d)} onClose={() => setPhoneModal(null)}/>
      <PhoneModal open={phoneModal?.type === 'edit'} initial={phoneModal?.phone} onSave={d => editPhone(phoneModal.phone.id, d)} onClose={() => setPhoneModal(null)}/>
      <ConfirmDialog open={!!confirmPhone} message="Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ" onConfirm={() => { deletePhone(confirmPhone); setConfirmPhone(null); }} onCancel={() => setConfirmPhone(null)}/>
      <ConfirmDialog open={confirm} message="ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒÙ† Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ" onConfirm={() => { onDelete(); setConfirm(false); }} onCancel={() => setConfirm(false)}/>
    </div>
  );
};

// â”€â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EmptyState = ({ onAdd }) => (
  <div className="flex flex-col items-center justify-center h-full text-center px-8 py-16 fade-in">
    <div className="w-28 h-28 rounded-full bg-gradient-to-br from-blue-100/80 to-indigo-100/80 dark:from-blue-900/30 dark:to-indigo-900/30 flex items-center justify-center mb-6 shadow-inner backdrop-blur-sm">
      <Icon name="userPlus" size={52} color="#6366f1"/>
    </div>
    <h2 className="text-2xl font-extrabold text-slate-700 dark:text-slate-200 mb-2">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</h2>
    <p className="text-slate-400 dark:text-slate-500 text-base leading-relaxed mb-8">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.<br/>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ ÛŒÚ© Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</p>
    <button onClick={onAdd} className="flex items-center gap-2 px-8 py-4 bg-indigo-500 text-white rounded-2xl text-lg font-bold shadow-lg active:bg-indigo-600"><Icon name="plus" size={22} color="white"/> Ø§ÙØ²ÙˆØ¯Ù† Ø§ÙˆÙ„ÛŒÙ† Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡</button>
  </div>
);

// â”€â”€â”€ Medication Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MedModal = ({ open, initial, onSave, onClose }) => {
  const [name, setName] = useState('');
  const [dose, setDose] = useState('');
  const [time, setTime] = useState('morning');
  const [type, setType] = useState('pill');
  useEffect(() => { if (open) { setName(initial?.name || ''); setDose(initial?.dose || ''); setTime(initial?.time || 'morning'); setType(initial?.type || 'pill'); } }, [open, initial]);
  if (!open) return null;
  const handleSave = () => { if (!name.trim()) return; onSave({ name: name.trim(), dose: dose.trim(), time, type }); onClose(); };
  const timeOptions = [
    { value: 'morning', label: 'ğŸŒ… ØµØ¨Ø­', color: 'bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-300 border-amber-300 dark:border-amber-700' },
    { value: 'noon', label: 'â˜€ï¸ Ø¸Ù‡Ø±', color: 'bg-orange-100 dark:bg-orange-900/40 text-orange-700 dark:text-orange-300 border-orange-300 dark:border-orange-700' },
    { value: 'night', label: 'ğŸŒ™ Ø´Ø¨', color: 'bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300 border-indigo-300 dark:border-indigo-700' },
  ];
  const typeOptions = [
    { value: 'pill', label: 'Ù‚Ø±Øµ', icon: 'pill' },
    { value: 'syrup', label: 'Ø´Ø±Ø¨Øª', icon: 'syrup' },
    { value: 'injection', label: 'Ø¢Ù…Ù¾ÙˆÙ„', icon: 'injection' },
  ];
  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center modal-overlay" style={{background:'rgba(15,23,42,0.6)'}}>
      <div className="w-full max-w-lg glass rounded-t-3xl p-6 modal-animate" style={{paddingBottom:'max(1.5rem, env(safe-area-inset-bottom))'}}>
        <div className="w-12 h-1.5 bg-slate-300 dark:bg-slate-600 rounded-full mx-auto mb-5"/>
        <h2 className="text-xl font-bold text-slate-800 dark:text-slate-100 mb-5 text-center">{initial ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø§Ø±Ùˆ' : 'Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø±ÙˆÛŒ Ø¬Ø¯ÛŒØ¯'}</h2>
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1.5">Ù†Ø§Ù… Ø¯Ø§Ø±Ùˆ</label>
            <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Ù…Ø«Ø§Ù„: Ù…ØªÙÙˆØ±Ù…ÛŒÙ†"
              className="w-full border-2 border-slate-200/60 dark:border-slate-600/60 rounded-2xl px-4 py-3 text-slate-800 dark:text-slate-100 bg-white/80 dark:bg-slate-700/80 text-base focus:outline-none focus:border-blue-400 transition-colors backdrop-blur-sm"
              style={{userSelect:'text', WebkitUserSelect:'text'}} autoFocus />
          </div>
          <div>
            <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1.5">Ø¯ÙˆØ² Ù…ØµØ±Ù</label>
            <input type="text" value={dose} onChange={e => setDose(e.target.value)} placeholder="Ù…Ø«Ø§Ù„: ÛµÛ°Û° Ù…ÛŒÙ„ÛŒâ€ŒÚ¯Ø±Ù…"
              className="w-full border-2 border-slate-200/60 dark:border-slate-600/60 rounded-2xl px-4 py-3 text-slate-800 dark:text-slate-100 bg-white/80 dark:bg-slate-700/80 text-base focus:outline-none focus:border-blue-400 transition-colors backdrop-blur-sm"
              style={{userSelect:'text', WebkitUserSelect:'text'}} />
          </div>
          <div>
            <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-2">Ø²Ù…Ø§Ù† Ù…ØµØ±Ù</label>
            <div className="flex gap-2">
              {timeOptions.map(t => (
                <button key={t.value} onClick={() => setTime(t.value)}
                  className={`flex-1 py-3 rounded-2xl text-sm font-bold border-2 transition-all ${time === t.value ? t.color : 'bg-slate-50/80 dark:bg-slate-700/60 text-slate-500 dark:text-slate-400 border-transparent'}`}>
                  {t.label}
                </button>
              ))}
            </div>
          </div>
          <div>
            <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-2">Ù†ÙˆØ¹ Ø¯Ø§Ø±Ùˆ</label>
            <div className="flex gap-2">
              {typeOptions.map(t => (
                <button key={t.value} onClick={() => setType(t.value)}
                  className={`flex-1 py-3 rounded-2xl text-sm font-bold border-2 transition-all flex items-center justify-center gap-2 ${type === t.value ? 'bg-blue-50/80 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 border-blue-300 dark:border-blue-700' : 'bg-slate-50/80 dark:bg-slate-700/60 text-slate-500 dark:text-slate-400 border-transparent'}`}>
                  <Icon name={t.icon} size={18} color={type === t.value ? '#3b82f6' : '#94a3b8'}/> {t.label}
                </button>
              ))}
            </div>
          </div>
        </div>
        <div className="flex gap-3 mt-6">
          <button onClick={onClose} className="flex-1 py-3.5 rounded-2xl bg-slate-100/80 dark:bg-slate-700/80 text-slate-600 dark:text-slate-300 font-semibold text-base active:bg-slate-200 backdrop-blur-sm">Ø§Ù†ØµØ±Ø§Ù</button>
          <button onClick={handleSave} disabled={!name.trim()} className="flex-1 py-3.5 rounded-2xl bg-blue-500 text-white font-bold text-base active:bg-blue-600 disabled:opacity-40">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
      </div>
    </div>
  );
};

// â”€â”€â”€ Medication Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MedCard = ({ med, taken, onToggle, onEdit, onDelete }) => {
  const timeColors = {
    morning: { bg: 'bg-amber-50/80 dark:bg-amber-900/20', border: 'border-amber-200/60 dark:border-amber-800/40', accent: '#f59e0b' },
    noon: { bg: 'bg-orange-50/80 dark:bg-orange-900/20', border: 'border-orange-200/60 dark:border-orange-800/40', accent: '#f97316' },
    night: { bg: 'bg-indigo-50/80 dark:bg-indigo-900/20', border: 'border-indigo-200/60 dark:border-indigo-800/40', accent: '#6366f1' },
  };
  const timeLabels = { morning: 'ğŸŒ… ØµØ¨Ø­', noon: 'â˜€ï¸ Ø¸Ù‡Ø±', night: 'ğŸŒ™ Ø´Ø¨' };
  const tc = timeColors[med.time] || timeColors.morning;

  return (
    <div className={`rounded-3xl p-4 card-shadow slide-up border backdrop-blur-sm transition-all duration-300 ${taken ? 'bg-emerald-50/80 dark:bg-emerald-900/20 border-emerald-300/60 dark:border-emerald-700/40' : `${tc.bg} ${tc.border}`}`}>
      <div className="flex items-center gap-3">
        <button onClick={onToggle} className={`w-14 h-14 rounded-2xl flex items-center justify-center transition-all duration-300 ${taken ? 'bg-emerald-500 shadow-lg check-pop' : 'bg-white/60 dark:bg-slate-700/60 border-2 border-slate-200/60 dark:border-slate-600/40'}`}>
          {taken ? <Icon name="check" size={28} color="white"/> : <Icon name={med.type || 'pill'} size={28} color={tc.accent}/>}
        </button>
        <div className="flex-1 min-w-0">
          <p className={`font-bold text-base truncate ${taken ? 'text-emerald-700 dark:text-emerald-300 line-through' : 'text-slate-800 dark:text-slate-100'}`}>{med.name}</p>
          {med.dose && <p className={`text-sm mt-0.5 ${taken ? 'text-emerald-500 dark:text-emerald-400' : 'text-slate-500 dark:text-slate-400'}`}>{med.dose}</p>}
          <p className="text-xs mt-1 opacity-70">{timeLabels[med.time]}</p>
        </div>
        <div className="flex gap-2 flex-shrink-0">
          <button onClick={onEdit} className="w-10 h-10 bg-blue-50/80 dark:bg-blue-900/30 rounded-xl flex items-center justify-center active:bg-blue-100 backdrop-blur-sm"><Icon name="edit" size={16} color="#3b82f6"/></button>
          <button onClick={onDelete} className="w-10 h-10 bg-red-50/80 dark:bg-red-900/30 rounded-xl flex items-center justify-center active:bg-red-100 backdrop-blur-sm"><Icon name="trash" size={16} color="#ef4444"/></button>
        </div>
      </div>
    </div>
  );
};

// â”€â”€â”€ Medication Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MedicationPage = ({ meds, setMeds }) => {
  const [modal, setModal] = useState(null);
  const [confirm, setConfirm] = useState(null);
  const [doneMap, setDoneMap] = useState(() => {
    const all = load(MED_DONE_KEY, {});
    return all[todayKey()] || {};
  });

  useEffect(() => {
    const all = load(MED_DONE_KEY, {});
    all[todayKey()] = doneMap;
    // Clean old entries (keep last 7 days)
    const keys = Object.keys(all).sort().reverse();
    const cleaned = {};
    keys.slice(0, 7).forEach(k => cleaned[k] = all[k]);
    save(MED_DONE_KEY, cleaned);
  }, [doneMap]);

  const toggleDone = (id) => setDoneMap(p => ({ ...p, [id]: !p[id] }));

  const grouped = useMemo(() => {
    const g = { morning: [], noon: [], night: [] };
    meds.forEach(m => { (g[m.time] || g.morning).push(m); });
    return g;
  }, [meds]);

  const groupLabels = { morning: 'ğŸŒ… Ø¯Ø§Ø±ÙˆÙ‡Ø§ÛŒ ØµØ¨Ø­', noon: 'â˜€ï¸ Ø¯Ø§Ø±ÙˆÙ‡Ø§ÛŒ Ø¸Ù‡Ø±', night: 'ğŸŒ™ Ø¯Ø§Ø±ÙˆÙ‡Ø§ÛŒ Ø´Ø¨' };
  const totalCount = meds.length;
  const doneCount = meds.filter(m => doneMap[m.id]).length;

  return (
    <div className="flex-1 scroll-area" style={{minHeight:0}}>
      {meds.length === 0 ? (
        <div className="flex flex-col items-center justify-center h-full text-center px-8 py-16 fade-in">
          <div className="w-28 h-28 rounded-full bg-gradient-to-br from-emerald-100/80 to-teal-100/80 dark:from-emerald-900/30 dark:to-teal-900/30 flex items-center justify-center mb-6 shadow-inner backdrop-blur-sm">
            <Icon name="medicine" size={52} color="#10b981"/>
          </div>
          <h2 className="text-2xl font-extrabold text-slate-700 dark:text-slate-200 mb-2">Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡ Ù…Ù†</h2>
          <p className="text-slate-400 dark:text-slate-500 text-base leading-relaxed mb-8">Ù‡Ù†ÙˆØ² Ø¯Ø§Ø±ÙˆÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.<br/>Ø¯Ø§Ø±ÙˆÙ‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯ ØªØ§ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø´ÙˆÛŒØ¯.</p>
          <button onClick={() => setModal({type:'add'})} className="flex items-center gap-2 px-8 py-4 bg-emerald-500 text-white rounded-2xl text-lg font-bold shadow-lg active:bg-emerald-600"><Icon name="plus" size={22} color="white"/> Ø§ÙØ²ÙˆØ¯Ù† Ø§ÙˆÙ„ÛŒÙ† Ø¯Ø§Ø±Ùˆ</button>
        </div>
      ) : (
        <div className="p-4 space-y-4 pb-32">
          {/* Progress */}
          <div className="glass rounded-3xl p-4 card-shadow">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-bold text-slate-700 dark:text-slate-200">ÙˆØ¶Ø¹ÛŒØª Ø§Ù…Ø±ÙˆØ²</span>
              <span className="text-sm font-bold text-emerald-600 dark:text-emerald-400">{toPersian(doneCount)} Ø§Ø² {toPersian(totalCount)}</span>
            </div>
            <div className="w-full h-3 bg-slate-200/60 dark:bg-slate-700/60 rounded-full overflow-hidden backdrop-blur-sm">
              <div className="h-full bg-gradient-to-l from-emerald-400 to-emerald-500 rounded-full transition-all duration-500" style={{width: `${totalCount > 0 ? (doneCount/totalCount)*100 : 0}%`}}/>
            </div>
          </div>

          {/* Add button */}
          <button onClick={() => setModal({type:'add'})} className="w-full flex items-center justify-center gap-2 py-3 glass rounded-2xl text-emerald-600 dark:text-emerald-400 font-bold active:bg-emerald-50/80 card-shadow">
            <Icon name="plus" size={20} color="#10b981"/> Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø±ÙˆÛŒ Ø¬Ø¯ÛŒØ¯
          </button>

          {/* Groups */}
          {['morning','noon','night'].map(time => {
            if (grouped[time].length === 0) return null;
            return (
              <div key={time} className="space-y-2">
                <h3 className="text-sm font-bold text-slate-500 dark:text-slate-400 px-1">{groupLabels[time]}</h3>
                {grouped[time].map(m => (
                  <MedCard key={m.id} med={m} taken={!!doneMap[m.id]}
                    onToggle={() => toggleDone(m.id)}
                    onEdit={() => setModal({type:'edit', med:m})}
                    onDelete={() => setConfirm(m.id)}
                  />
                ))}
              </div>
            );
          })}
        </div>
      )}

      <MedModal open={modal?.type==='add'} initial={null} onSave={d => setMeds(p => [...p, {id:uid(), ...d}])} onClose={() => setModal(null)}/>
      <MedModal open={modal?.type==='edit'} initial={modal?.med} onSave={d => setMeds(p => p.map(m => m.id===modal.med.id ? {...m, ...d} : m))} onClose={() => setModal(null)}/>
      <ConfirmDialog open={!!confirm} message="Ø§ÛŒÙ† Ø¯Ø§Ø±Ùˆ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ" onConfirm={() => { setMeds(p => p.filter(m => m.id !== confirm)); setConfirm(null); }} onCancel={() => setConfirm(null)}/>
    </div>
  );
};

// â”€â”€â”€ App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const App = () => {
  const [contacts, setContacts] = useState(() => loadContacts());
  const [meds, setMeds] = useState(() => load(MED_KEY, []));
  const [modal, setModal] = useState(null);
  const [dark, setDark] = useState(() => localStorage.getItem(DM_KEY) === 'true');
  const [zoom, setZoom] = useState(() => parseInt(localStorage.getItem(ZOOM_KEY)) || 100);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchOpen, setSearchOpen] = useState(false);
  const [searchVersion, setSearchVersion] = useState(0);
  const [activeTab, setActiveTab] = useState('contacts');
  const searchInputRef = useRef();

  useEffect(() => { document.documentElement.classList.toggle('dark', dark); localStorage.setItem(DM_KEY, dark ? 'true' : 'false'); }, [dark]);
  useEffect(() => { save(LS_KEY, contacts); }, [contacts]);
  useEffect(() => { save(MED_KEY, meds); }, [meds]);
  useEffect(() => { if (searchQuery) setSearchVersion(v => v + 1); }, [searchQuery]);
  useEffect(() => { document.documentElement.style.fontSize = `${zoom}%`; localStorage.setItem(ZOOM_KEY, String(zoom)); }, [zoom]);

  const addFamily = (d) => setContacts(p => [...p, {id:uid(), name:d.name, phones:[], image:null, subContacts:[]}]);
  const updateFamily = (id, p) => setContacts(prev => prev.map(c => c.id===id ? p : c));
  const deleteFamily = (id) => setContacts(p => p.filter(c => c.id!==id));

  const filteredContacts = searchQuery ? contacts.filter(c => familyMatchesSearch(c, searchQuery)) : contacts;
  const shouldForceOpen = (f) => { if(!searchQuery) return false; for(const ch of (f.subContacts||[])) { if(matchesSearch(ch, searchQuery)) return true; for(const gc of (ch.subContacts||[])) { if(matchesSearch(gc, searchQuery)) return true; } } return false; };

  return (
    <div className="flex flex-col bg-gradient-to-br from-slate-100 via-slate-50 to-blue-50/30 dark:from-slate-900 dark:via-slate-900 dark:to-slate-800" style={{height:'100vh', width:'100vw'}}>
      <StatusBar/>

      {/* Header */}
      <div className="glass border-b border-slate-200/40 dark:border-slate-700/40 px-4 py-3 flex items-center justify-between" style={{zIndex:10}}>
        <div className="flex-1 min-w-0">
          <h1 className="text-xl font-extrabold text-slate-800 dark:text-slate-100 leading-tight">
            {activeTab === 'contacts' ? 'Ø¯ÙØªØ±Ú†Ù‡ ØªÙ…Ø§Ø³' : 'Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡ Ù…Ù†'}
          </h1>
          <p className="text-slate-400 dark:text-slate-500 text-xs mt-0.5">
            {activeTab === 'contacts'
              ? (contacts.length > 0 ? `${toPersian(contacts.length)} Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡` : 'Ù…Ø®Ø§Ø·Ø¨ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡')
              : (meds.length > 0 ? `${toPersian(meds.length)} Ø¯Ø§Ø±Ùˆ` : 'Ø¯Ø§Ø±ÙˆÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡')}
          </p>
        </div>
        <div className="flex items-center gap-1.5">
          {/* Zoom */}
          <button onClick={() => setZoom(z => Math.min(150, z + 10))} className="w-9 h-9 rounded-xl flex items-center justify-center bg-slate-100/80 dark:bg-slate-700/60 active:bg-slate-200 backdrop-blur-sm" aria-label="Ø¨Ø²Ø±Ú¯â€ŒØªØ±"><Icon name="zoomIn" size={18} color="#64748b"/></button>
          <button onClick={() => setZoom(z => Math.max(80, z - 10))} className="w-9 h-9 rounded-xl flex items-center justify-center bg-slate-100/80 dark:bg-slate-700/60 active:bg-slate-200 backdrop-blur-sm" aria-label="Ú©ÙˆÚ†Ú©â€ŒØªØ±"><Icon name="zoomOut" size={18} color="#64748b"/></button>
          {/* Dark */}
          <button onClick={() => setDark(d => !d)} className="w-9 h-9 rounded-xl flex items-center justify-center bg-slate-100/80 dark:bg-slate-700/60 active:bg-slate-200 backdrop-blur-sm" aria-label="ØªÙ…">
            {dark ? <Icon name="sun" size={18} color="#fbbf24"/> : <Icon name="moon" size={18} color="#64748b"/>}
          </button>
          {/* Export */}
          <button onClick={() => exportData(contacts, meds)} className="w-9 h-9 rounded-xl flex items-center justify-center bg-slate-100/80 dark:bg-slate-700/60 active:bg-slate-200 backdrop-blur-sm" aria-label="Ø®Ø±ÙˆØ¬ÛŒ"><Icon name="download" size={18} color="#64748b"/></button>

          {activeTab === 'contacts' && (
            <>
              <button onClick={() => { setSearchOpen(o => !o); if (!searchOpen) setTimeout(() => searchInputRef.current?.focus(), 100); }}
                className="w-9 h-9 rounded-xl flex items-center justify-center bg-slate-100/80 dark:bg-slate-700/60 active:bg-slate-200 backdrop-blur-sm" aria-label="Ø¬Ø³ØªØ¬Ùˆ"><Icon name="search" size={18} color="#64748b"/></button>
              <button onClick={() => setModal('add-family')} className="flex items-center gap-1.5 px-3 py-2 bg-indigo-500 text-white rounded-2xl font-bold text-sm active:bg-indigo-600 shadow-md">
                <Icon name="plus" size={16} color="white"/> Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯
              </button>
            </>
          )}
        </div>
      </div>

      {/* Search Bar */}
      {searchOpen && activeTab === 'contacts' && (
        <div className="glass border-b border-slate-200/40 dark:border-slate-700/40 px-4 py-2 flex items-center gap-3 fade-in">
          <Icon name="search" size={18} color="#94a3b8"/>
          <input ref={searchInputRef} type="text" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø§Ù… ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡..."
            className="flex-1 bg-transparent text-slate-800 dark:text-slate-100 text-sm focus:outline-none placeholder:text-slate-400 dark:placeholder:text-slate-500" style={{userSelect:'text', WebkitUserSelect:'text'}}/>
          {searchQuery && <button onClick={() => setSearchQuery('')} className="p-1"><Icon name="close" size={16} color="#94a3b8"/></button>}
          <button onClick={() => { setSearchOpen(false); setSearchQuery(''); }} className="text-slate-400 text-xs font-semibold">Ø¨Ø³ØªÙ†</button>
        </div>
      )}

      {/* Main Content */}
      {activeTab === 'contacts' ? (
        <div className="flex-1 scroll-area" style={{minHeight:0}}>
          {contacts.length === 0 ? (
            <EmptyState onAdd={() => setModal('add-family')}/>
          ) : filteredContacts.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-20 text-center fade-in">
              <Icon name="search" size={48} color="#94a3b8"/>
              <p className="text-slate-400 text-base mt-4">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
            </div>
          ) : (
            <div className="p-4 space-y-4 pb-44">
              {filteredContacts.map(c => (
                <Level1Card key={c.id + '-' + searchVersion} contact={c} onChange={p => updateFamily(c.id, p)} onDelete={() => deleteFamily(c.id)} forceOpen={shouldForceOpen(c)} searchQuery={searchQuery}/>
              ))}
            </div>
          )}
        </div>
      ) : (
        <MedicationPage meds={meds} setMeds={setMeds}/>
      )}

      {/* SOS Button - always visible */}
      <div className="px-4 pb-1 pt-2" style={{zIndex:20}}>
        <a href="tel:115" className="pulse-sos flex items-center justify-center gap-3 w-full py-3.5 bg-red-500 text-white rounded-2xl font-extrabold text-lg shadow-xl active:bg-red-600">
          <Icon name="alertCircle" size={24} color="white"/> Ø§ÙˆØ±Ú˜Ø§Ù†Ø³ â€” Û±Û±Ûµ
        </a>
      </div>

      {/* Tab Bar */}
      <div className="glass border-t border-slate-200/40 dark:border-slate-700/40 flex" style={{paddingBottom:'max(0.5rem, env(safe-area-inset-bottom))', zIndex:20}}>
        <button onClick={() => setActiveTab('contacts')}
          className={`flex-1 flex flex-col items-center gap-1 py-2 transition-colors ${activeTab === 'contacts' ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400 dark:text-slate-500'}`}>
          <Icon name="contacts" size={24} color={activeTab === 'contacts' ? '#4f46e5' : '#94a3b8'}/>
          <span className="text-xs font-bold">Ù…Ø®Ø§Ø·Ø¨Ø§Ù†</span>
        </button>
        <button onClick={() => setActiveTab('pharmacy')}
          className={`flex-1 flex flex-col items-center gap-1 py-2 transition-colors ${activeTab === 'pharmacy' ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-400 dark:text-slate-500'}`}>
          <Icon name="medicine" size={24} color={activeTab === 'pharmacy' ? '#10b981' : '#94a3b8'}/>
          <span className="text-xs font-bold">Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡ Ù…Ù†</span>
        </button>
      </div>

      <ContactModal open={modal === 'add-family'} initial={null} onSave={addFamily} onClose={() => setModal(null)}/>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
