<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>دفترچه تماس خانوادگی</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            vazir: ['Vazirmatn', 'sans-serif'],
          },
          colors: {
            slate: {
              850: '#1a2332',
            }
          }
        }
      }
    }
  </script>
  <style>
    * {
      font-family: 'Vazirmatn', sans-serif !important;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
      box-sizing: border-box;
    }
    html, body {
      overflow: hidden;
      height: 100%;
      width: 100%;
      touch-action: manipulation;
    }
    #root {
      height: 100%;
      width: 100%;
    }
    .scroll-area {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .scroll-area::-webkit-scrollbar { display: none; }
    .scroll-area { -ms-overflow-style: none; scrollbar-width: none; }

    input, textarea {
      user-select: text !important;
      -webkit-user-select: text !important;
    }
    .accordion-enter { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.35s ease, opacity 0.25s ease; }
    .accordion-open { max-height: 9999px; opacity: 1; overflow: visible; transition: max-height 0.5s ease, opacity 0.3s ease; }

    .card-shadow { box-shadow: 0 4px 24px 0 rgba(0,0,0,0.10), 0 1px 4px rgba(0,0,0,0.07); }
    .pulse-sos { animation: pulse-sos 1.8s infinite; }
    @keyframes pulse-sos {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
      50% { box-shadow: 0 0 0 16px rgba(239,68,68,0); }
    }
    .photo-ring { border: 3px solid #e2e8f0; }
    .dark .photo-ring { border-color: #475569; }
    .photo-ring-green { border: 3px solid #22c55e; }
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
    .modal-overlay {
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
  </style>
</head>
<body class="bg-slate-900">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ─── Persian digit conversion ──────────────────────────────────────────────
const toPersian = (n) => {
  const digits = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
  return String(n).replace(/[0-9]/g, d => digits[d]);
};

// ─── UUID ──────────────────────────────────────────────────────────────────
const uid = () => Math.random().toString(36).slice(2, 10) + Date.now().toString(36);

// ─── Image → Base64 ───────────────────────────────────────────────────────
const fileToBase64 = (file) => new Promise((res, rej) => {
  const reader = new FileReader();
  reader.onload = () => res(reader.result);
  reader.onerror = rej;
  reader.readAsDataURL(file);
});

// ─── LocalStorage helpers ──────────────────────────────────────────────────
const LS_KEY = 'persian-contacts-v2';
const loadContacts = () => {
  try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
  catch { return []; }
};
const saveContacts = (data) => {
  try { localStorage.setItem(LS_KEY, JSON.stringify(data)); } catch {}
};

// ─── Dark Mode helpers ─────────────────────────────────────────────────────
const DM_KEY = 'persian-contacts-dark';
const loadDarkMode = () => {
  try { return localStorage.getItem(DM_KEY) === 'true'; } catch { return false; }
};

// ─── Share helper ──────────────────────────────────────────────────────────
const shareContact = async (name, phone) => {
  const text = `${name}\n${phone}`;
  if (navigator.share) {
    try { await navigator.share({ title: name, text }); } catch {}
  } else {
    try {
      await navigator.clipboard.writeText(text);
      alert('اطلاعات در کلیپ‌بورد کپی شد');
    } catch {}
  }
};

// ─── Search helper ─────────────────────────────────────────────────────────
const matchesSearch = (contact, query) => {
  if (!query) return true;
  const q = query.toLowerCase();
  if (contact.name?.toLowerCase().includes(q)) return true;
  if (contact.phone?.includes(query)) return true;
  return false;
};
const familyMatchesSearch = (family, query) => {
  if (!query) return true;
  if (matchesSearch(family, query)) return true;
  for (const child of (family.subContacts || [])) {
    if (matchesSearch(child, query)) return true;
    for (const gc of (child.subContacts || [])) {
      if (matchesSearch(gc, query)) return true;
    }
  }
  return false;
};

// ─── SVG Icons ────────────────────────────────────────────────────────────
const Icon = ({ name, size = 20, color = 'currentColor', className = '' }) => {
  const icons = {
    battery: (charging) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={charging ? '#22c55e' : color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <rect x="1" y="6" width="18" height="12" rx="2" ry="2"/>
        <line x1="23" y1="13" x2="23" y2="11"/>
        {charging && <path d="M11 6l-4 6h6l-4 6" stroke="#22c55e" strokeWidth="2.2"/>}
      </svg>
    ),
    wifi: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><circle cx="12" cy="20" r="1" fill={color}/>
      </svg>
    ),
    signal: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill={color} className={className}>
        <rect x="1" y="16" width="4" height="7" rx="1"/><rect x="7" y="11" width="4" height="12" rx="1"/><rect x="13" y="6" width="4" height="17" rx="1" opacity=".7"/><rect x="19" y="1" width="4" height="22" rx="1" opacity=".4"/>
      </svg>
    ),
    phone: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.62 3.47 2 2 0 0 1 3.6 1.25h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.96a16 16 0 0 0 6.29 6.29l.93-.93a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/>
      </svg>
    ),
    camera: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>
      </svg>
    ),
    chevronDown: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="6 9 12 15 18 9"/>
      </svg>
    ),
    chevronUp: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="18 15 12 9 6 15"/>
      </svg>
    ),
    plus: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
    ),
    userPlus: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
      </svg>
    ),
    trash: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
      </svg>
    ),
    edit: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
    ),
    alertCircle: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
    ),
    sos: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/>
      </svg>
    ),
    share: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
    ),
    search: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
    ),
    sun: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
    ),
    moon: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
    ),
    close: (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    ),
  };
  if (name === 'battery') return icons.battery(false);
  return icons[name] || null;
};

const BatteryIcon = ({ level, charging }) => {
  const fill = charging ? '#22c55e' : level > 20 ? '#94a3b8' : '#ef4444';
  const w = Math.max(0, Math.min(100, level));
  return (
    <svg width="26" height="14" viewBox="0 0 26 14" fill="none">
      <rect x="0.5" y="0.5" width="22" height="13" rx="2.5" stroke={fill} strokeWidth="1.2"/>
      <rect x="2" y="2" width={w * 0.18} height="10" rx="1.5" fill={charging ? '#22c55e' : level > 20 ? '#94a3b8' : '#ef4444'}/>
      <rect x="23" y="4" width="2.5" height="6" rx="1.2" fill={fill} opacity="0.7"/>
      {charging && (
        <text x="11" y="10.5" textAnchor="middle" fontSize="9" fill="#22c55e" fontWeight="bold">⚡</text>
      )}
    </svg>
  );
};

// ─── Status Bar ────────────────────────────────────────────────────────────
const StatusBar = () => {
  const [time, setTime] = useState('');
  const [battery, setBattery] = useState({ level: 100, charging: false });

  useEffect(() => {
    const tick = () => {
      const now = new Date();
      const h = String(now.getHours()).padStart(2,'0');
      const m = String(now.getMinutes()).padStart(2,'0');
      setTime(toPersian(`${h}:${m}`));
    };
    tick();
    const id = setInterval(tick, 1000);
    return () => clearInterval(id);
  }, []);

  useEffect(() => {
    if ('getBattery' in navigator) {
      navigator.getBattery().then(bat => {
        const update = () => setBattery({ level: Math.round(bat.level * 100), charging: bat.charging });
        update();
        bat.addEventListener('levelchange', update);
        bat.addEventListener('chargingchange', update);
      }).catch(() => {});
    }
  }, []);

  return (
    <div className="flex items-center justify-between px-4 py-1 bg-slate-800 text-slate-300 text-xs" style={{minHeight: 28}}>
      <div className="flex items-center gap-2">
        <Icon name="signal" size={14} color="#94a3b8"/>
        <Icon name="wifi" size={14} color="#94a3b8"/>
      </div>
      <span className="font-bold text-sm tracking-wider" style={{letterSpacing:'0.08em'}}>{time}</span>
      <div className="flex items-center gap-1.5">
        <span className="text-xs" style={{fontSize:11}}>{toPersian(battery.level)}٪</span>
        <BatteryIcon level={battery.level} charging={battery.charging}/>
      </div>
    </div>
  );
};

// ─── Modal ─────────────────────────────────────────────────────────────────
const ContactModal = ({ open, initial, onSave, onClose }) => {
  const [name, setName] = useState('');
  const [phone, setPhone] = useState('');

  useEffect(() => {
    if (open) {
      setName(initial?.name || '');
      setPhone(initial?.phone || '');
    }
  }, [open, initial]);

  if (!open) return null;

  const handleSave = () => {
    if (!name.trim()) return;
    onSave({ name: name.trim(), phone: phone.trim() });
    onClose();
  };

  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center modal-overlay" style={{background:'rgba(15,23,42,0.75)'}}>
      <div className="w-full max-w-lg bg-white dark:bg-slate-800 rounded-t-3xl p-6 fade-in" style={{paddingBottom: 'max(1.5rem, env(safe-area-inset-bottom))'}}>
        <div className="w-12 h-1.5 bg-slate-200 dark:bg-slate-600 rounded-full mx-auto mb-5"/>
        <h2 className="text-xl font-bold text-slate-800 dark:text-slate-100 mb-5 text-center">
          {initial ? 'ویرایش اطلاعات' : 'افزودن مخاطب'}
        </h2>
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1.5">نام و نام خانوادگی</label>
            <input
              type="text"
              value={name}
              onChange={e => setName(e.target.value)}
              placeholder="مثال: علی رضایی"
              className="w-full border-2 border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 text-slate-800 dark:text-slate-100 bg-white dark:bg-slate-700 text-base focus:outline-none focus:border-blue-400 transition-colors"
              style={{userSelect:'text', WebkitUserSelect:'text'}}
              autoFocus
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1.5">شماره تلفن</label>
            <input
              type="tel"
              inputMode="numeric"
              pattern="[0-9]*"
              value={phone}
              onChange={e => setPhone(e.target.value)}
              placeholder="مثال: ۰۹۱۲۱۲۳۴۵۶۷"
              className="w-full border-2 border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 text-slate-800 dark:text-slate-100 bg-white dark:bg-slate-700 text-base focus:outline-none focus:border-blue-400 transition-colors"
              style={{userSelect:'text', WebkitUserSelect:'text', direction:'ltr', textAlign:'right'}}
            />
          </div>
        </div>
        <div className="flex gap-3 mt-6">
          <button
            onClick={onClose}
            className="flex-1 py-3.5 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-semibold text-base active:bg-slate-200 dark:active:bg-slate-600 transition-colors"
          >انصراف</button>
          <button
            onClick={handleSave}
            disabled={!name.trim()}
            className="flex-2 flex-1 py-3.5 rounded-xl bg-blue-500 text-white font-bold text-base active:bg-blue-600 transition-colors disabled:opacity-40"
          >ذخیره</button>
        </div>
      </div>
    </div>
  );
};

// ─── Confirm Dialog ────────────────────────────────────────────────────────
const ConfirmDialog = ({ open, message, onConfirm, onCancel }) => {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-6" style={{background:'rgba(15,23,42,0.75)'}}>
      <div className="w-full max-w-sm bg-white dark:bg-slate-800 rounded-3xl p-6 fade-in">
        <div className="flex justify-center mb-4">
          <Icon name="alertCircle" size={44} color="#ef4444"/>
        </div>
        <p className="text-slate-700 dark:text-slate-200 font-semibold text-center text-base mb-6">{message}</p>
        <div className="flex gap-3">
          <button onClick={onCancel} className="flex-1 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-semibold active:bg-slate-200 dark:active:bg-slate-600">نه</button>
          <button onClick={onConfirm} className="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold active:bg-red-600">بله، حذف شود</button>
        </div>
      </div>
    </div>
  );
};

// ─── Photo Uploader ────────────────────────────────────────────────────────
const PhotoUploader = ({ image, name, size = 80, onUpload }) => {
  const inputRef = useRef();
  const initials = name ? name.trim().split(' ').map(w=>w[0]).slice(0,2).join('') : '؟';

  const handleChange = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const b64 = await fileToBase64(file);
      onUpload(b64);
    } catch {}
    e.target.value = '';
  };

  return (
    <div className="relative flex-shrink-0" style={{width: size, height: size}} onClick={e => e.stopPropagation()}>
      <button
        onClick={() => inputRef.current?.click()}
        className="w-full h-full rounded-full overflow-hidden photo-ring focus:outline-none active:opacity-80 transition-opacity"
        style={{width: size, height: size}}
        aria-label="تغییر عکس"
      >
        {image ? (
          <img src={image} alt={name} className="w-full h-full object-cover" draggable={false}/>
        ) : (
          <div className="w-full h-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center">
            <span className="text-white font-bold" style={{fontSize: size * 0.3}}>{initials}</span>
          </div>
        )}
      </button>
      <button
        onClick={() => inputRef.current?.click()}
        className="absolute bottom-0 left-0 bg-blue-500 rounded-full flex items-center justify-center shadow-lg active:bg-blue-600 transition-colors"
        style={{width: Math.round(size * 0.36), height: Math.round(size * 0.36)}}
        aria-label="آپلود عکس"
      >
        <Icon name="camera" size={Math.round(size * 0.2)} color="white"/>
      </button>
      <input ref={inputRef} type="file" accept="image/*" capture="environment" className="hidden" onChange={handleChange}/>
    </div>
  );
};

// ─── Share Button ──────────────────────────────────────────────────────────
const ShareButton = ({ name, phone, size = 'md' }) => {
  if (!phone) return null;
  const cls = size === 'sm'
    ? 'w-9 h-9 bg-violet-50 dark:bg-violet-900/40 rounded-xl flex items-center justify-center active:bg-violet-100 dark:active:bg-violet-900/60'
    : 'w-10 h-10 bg-violet-50 dark:bg-violet-900/40 rounded-xl flex items-center justify-center active:bg-violet-100 dark:active:bg-violet-900/60 shadow-sm';
  const iconSize = size === 'sm' ? 14 : 18;
  return (
    <button
      onClick={e => { e.stopPropagation(); shareContact(name, phone); }}
      className={cls}
      aria-label="اشتراک‌گذاری"
    >
      <Icon name="share" size={iconSize} color="#7c3aed"/>
    </button>
  );
};

// ─── Level 3 Card ──────────────────────────────────────────────────────────
const Level3Card = ({ contact, onUpdatePhoto, onEdit, onDelete }) => (
  <div className="flex items-center gap-3 bg-white dark:bg-slate-700 rounded-2xl p-3 card-shadow border border-slate-100 dark:border-slate-600 fade-in">
    <PhotoUploader image={contact.image} name={contact.name} size={52} onUpload={b64 => onUpdatePhoto(b64)}/>
    <div className="flex-1 min-w-0">
      <p className="font-semibold text-slate-800 dark:text-slate-100 text-sm truncate">{contact.name}</p>
      {contact.phone && (
        <a href={`tel:${contact.phone}`} onClick={e => e.stopPropagation()}
           className="text-blue-500 dark:text-blue-400 text-xs font-mono" style={{direction:'ltr', display:'inline-block'}}>
          {toPersian(contact.phone)}
        </a>
      )}
    </div>
    <div className="flex gap-2 flex-shrink-0">
      <ShareButton name={contact.name} phone={contact.phone} size="sm"/>
      {contact.phone && (
        <a href={`tel:${contact.phone}`} onClick={e => e.stopPropagation()}
           className="w-9 h-9 bg-emerald-500 rounded-xl flex items-center justify-center active:bg-emerald-600 shadow-sm">
          <Icon name="phone" size={16} color="white"/>
        </a>
      )}
      <button onClick={e => { e.stopPropagation(); onEdit(); }}
              className="w-9 h-9 bg-blue-50 dark:bg-blue-900/40 rounded-xl flex items-center justify-center active:bg-blue-100 dark:active:bg-blue-900/60">
        <Icon name="edit" size={16} color="#3b82f6"/>
      </button>
      <button onClick={e => { e.stopPropagation(); onDelete(); }}
              className="w-9 h-9 bg-red-50 dark:bg-red-900/40 rounded-xl flex items-center justify-center active:bg-red-100 dark:active:bg-red-900/60">
        <Icon name="trash" size={16} color="#ef4444"/>
      </button>
    </div>
  </div>
);

// ─── Level 2 Card ──────────────────────────────────────────────────────────
const Level2Card = ({ contact, onUpdatePhoto, onEdit, onDelete, onAddChild, onUpdateChild, onDeleteChild, forceOpen }) => {
  const [open, setOpen] = useState(false);
  const [modal, setModal] = useState(null);
  const [confirm, setConfirm] = useState(null);

  useEffect(() => {
    if (forceOpen) setOpen(true);
  }, [forceOpen]);

  const handleAddL3 = (data) => {
    onAddChild({ id: uid(), name: data.name, phone: data.phone, image: null, subContacts: [] });
  };

  const handleEditL3 = (child, data) => {
    onUpdateChild(child.id, { ...child, ...data });
  };

  return (
    <div className="rounded-2xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-750 overflow-hidden fade-in card-shadow" style={{backgroundColor: 'var(--l2bg)'}}>
      <div
        className="flex items-center gap-3 p-3 cursor-pointer active:bg-slate-100 dark:active:bg-slate-600 transition-colors"
        onClick={() => setOpen(o => !o)}
      >
        <PhotoUploader image={contact.image} name={contact.name} size={58} onUpload={b64 => onUpdatePhoto(b64)}/>
        <div className="flex-1 min-w-0">
          <p className="font-bold text-slate-800 dark:text-slate-100 truncate">{contact.name}</p>
          {contact.phone && (
            <p className="text-slate-500 dark:text-slate-400 text-xs font-mono" style={{direction:'ltr', textAlign:'right'}}>
              {toPersian(contact.phone)}
            </p>
          )}
        </div>
        <div className="flex items-center gap-2 flex-shrink-0">
          <ShareButton name={contact.name} phone={contact.phone}/>
          {contact.phone && (
            <a href={`tel:${contact.phone}`} onClick={e => e.stopPropagation()}
               className="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center active:bg-emerald-600 shadow-sm">
              <Icon name="phone" size={18} color="white"/>
            </a>
          )}
          {open ? <Icon name="chevronUp" size={20} color="#94a3b8"/> : <Icon name="chevronDown" size={20} color="#94a3b8"/>}
        </div>
      </div>

      <div className={open ? 'accordion-open' : 'accordion-enter'}>
        {open && (
          <div className="px-3 pb-3 space-y-2">
            {/* Toolbar */}
            <div className="flex gap-2 flex-wrap pt-1">
              <button onClick={e => { e.stopPropagation(); setModal({ type:'add-l3' }); }}
                className="flex items-center gap-1.5 px-3 py-2 bg-indigo-50 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-300 rounded-xl text-xs font-semibold active:bg-indigo-100 dark:active:bg-indigo-900/60">
                <Icon name="userPlus" size={14} color="#4f46e5"/> افزودن
              </button>
              <button onClick={e => { e.stopPropagation(); setModal({ type:'edit', initial: contact }); }}
                className="flex items-center gap-1.5 px-3 py-2 bg-blue-50 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300 rounded-xl text-xs font-semibold active:bg-blue-100 dark:active:bg-blue-900/60">
                <Icon name="edit" size={14} color="#3b82f6"/> ویرایش
              </button>
              <button onClick={e => { e.stopPropagation(); setConfirm(true); }}
                className="flex items-center gap-1.5 px-3 py-2 bg-red-50 dark:bg-red-900/40 text-red-500 dark:text-red-300 rounded-xl text-xs font-semibold active:bg-red-100 dark:active:bg-red-900/60">
                <Icon name="trash" size={14} color="#ef4444"/> حذف
              </button>
            </div>

            {/* Level 3 */}
            {contact.subContacts?.length > 0 && (
              <div className="space-y-2">
                {contact.subContacts.map(child => (
                  <Level3Card
                    key={child.id}
                    contact={child}
                    onUpdatePhoto={b64 => onUpdateChild(child.id, { ...child, image: b64 })}
                    onEdit={() => setModal({ type:'edit-l3', child })}
                    onDelete={() => setConfirm({ childId: child.id })}
                  />
                ))}
              </div>
            )}
            {(!contact.subContacts || contact.subContacts.length === 0) && (
              <p className="text-slate-400 dark:text-slate-500 text-xs text-center py-2">همسر / نوه‌ای ثبت نشده</p>
            )}
          </div>
        )}
      </div>

      <ContactModal
        open={modal?.type === 'add-l3'}
        initial={null}
        onSave={handleAddL3}
        onClose={() => setModal(null)}
      />
      <ContactModal
        open={modal?.type === 'edit'}
        initial={modal?.initial}
        onSave={data => onEdit(data)}
        onClose={() => setModal(null)}
      />
      <ContactModal
        open={modal?.type === 'edit-l3'}
        initial={modal?.child}
        onSave={data => handleEditL3(modal.child, data)}
        onClose={() => setModal(null)}
      />
      <ConfirmDialog
        open={!!confirm}
        message={confirm?.childId ? 'این مخاطب حذف شود؟' : 'این فرزند و تمام زیرمجموعه‌هایش حذف شود؟'}
        onConfirm={() => {
          if (confirm?.childId) onDeleteChild(confirm.childId);
          else onDelete();
          setConfirm(null);
        }}
        onCancel={() => setConfirm(null)}
      />
    </div>
  );
};

// ─── Level 1 Card ──────────────────────────────────────────────────────────
const Level1Card = ({ contact, onChange, onDelete, forceOpen, searchQuery }) => {
  const [open, setOpen] = useState(false);
  const [modal, setModal] = useState(null);
  const [confirm, setConfirm] = useState(false);

  useEffect(() => {
    if (forceOpen) setOpen(true);
  }, [forceOpen]);

  const update = (patch) => onChange({ ...contact, ...patch });

  const addChild = (child) => update({ subContacts: [...(contact.subContacts || []), child] });

  const updateChild = (childId, patch) => update({
    subContacts: (contact.subContacts || []).map(c => c.id === childId ? patch : c)
  });

  const deleteChild = (childId) => update({
    subContacts: (contact.subContacts || []).filter(c => c.id !== childId)
  });

  const updateGrandchild = (childId, gcId, patch) => {
    const child = contact.subContacts?.find(c => c.id === childId);
    if (!child) return;
    const updatedChild = {
      ...child,
      subContacts: (child.subContacts || []).map(gc => gc.id === gcId ? patch : gc)
    };
    updateChild(childId, updatedChild);
  };

  const deleteGrandchild = (childId, gcId) => {
    const child = contact.subContacts?.find(c => c.id === childId);
    if (!child) return;
    const updatedChild = {
      ...child,
      subContacts: (child.subContacts || []).filter(gc => gc.id !== gcId)
    };
    updateChild(childId, updatedChild);
  };

  const addGrandchild = (childId, gc) => {
    const child = contact.subContacts?.find(c => c.id === childId);
    if (!child) return;
    const updatedChild = {
      ...child,
      subContacts: [...(child.subContacts || []), gc]
    };
    updateChild(childId, updatedChild);
  };

  // Determine which L2 children should be force-opened by search
  const childForceOpen = (child) => {
    if (!searchQuery) return false;
    // If the search matches a grandchild, force-open this child
    for (const gc of (child.subContacts || [])) {
      if (matchesSearch(gc, searchQuery)) return true;
    }
    return false;
  };

  return (
    <div className="bg-white dark:bg-slate-800 rounded-3xl card-shadow border border-slate-100 dark:border-slate-700 overflow-hidden fade-in">
      {/* Header */}
      <div
        className="flex items-center gap-4 p-4 cursor-pointer active:bg-slate-50 dark:active:bg-slate-700 transition-colors"
        onClick={() => setOpen(o => !o)}
      >
        <PhotoUploader
          image={contact.image}
          name={contact.name}
          size={78}
          onUpload={b64 => update({ image: b64 })}
        />
        <div className="flex-1 min-w-0">
          <h2 className="font-extrabold text-slate-800 dark:text-slate-100 text-lg truncate leading-tight">{contact.name}</h2>
          {contact.phone && (
            <p className="text-slate-400 dark:text-slate-500 text-sm font-mono mt-0.5" style={{direction:'ltr', textAlign:'right'}}>
              {toPersian(contact.phone)}
            </p>
          )}
          <p className="text-slate-400 dark:text-slate-500 text-xs mt-1">
            {contact.subContacts?.length > 0
              ? `${toPersian(contact.subContacts.length)} فرزند`
              : 'فرزندی ثبت نشده'}
          </p>
        </div>
        <div className="flex flex-col items-center gap-2 flex-shrink-0">
          <div className="flex items-center gap-2">
            <ShareButton name={contact.name} phone={contact.phone}/>
            {contact.phone && (
              <a href={`tel:${contact.phone}`} onClick={e => e.stopPropagation()}
                 className="w-14 h-14 bg-emerald-500 rounded-2xl flex items-center justify-center active:bg-emerald-600 shadow-md"
                 aria-label={`تماس با ${contact.name}`}>
                <Icon name="phone" size={24} color="white"/>
              </a>
            )}
          </div>
          <div className="text-slate-300">
            {open ? <Icon name="chevronUp" size={22} color="#94a3b8"/> : <Icon name="chevronDown" size={22} color="#94a3b8"/>}
          </div>
        </div>
      </div>

      {/* Expanded Body */}
      <div className={open ? 'accordion-open' : 'accordion-enter'}>
        {open && (
          <div className="px-4 pb-4 space-y-3 border-t border-slate-100 dark:border-slate-700 pt-3">
            {/* Toolbar */}
            <div className="flex gap-2 flex-wrap">
              <button onClick={() => setModal({ type:'add-child' })}
                className="flex items-center gap-1.5 px-3 py-2.5 bg-indigo-500 text-white rounded-xl text-sm font-semibold active:bg-indigo-600 shadow-sm">
                <Icon name="userPlus" size={16} color="white"/> افزودن فرزند
              </button>
              <button onClick={() => setModal({ type:'edit', initial: contact })}
                className="flex items-center gap-1.5 px-3 py-2.5 bg-blue-50 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300 rounded-xl text-sm font-semibold active:bg-blue-100 dark:active:bg-blue-900/60">
                <Icon name="edit" size={16} color="#3b82f6"/> ویرایش
              </button>
              <button onClick={() => setConfirm(true)}
                className="flex items-center gap-1.5 px-3 py-2.5 bg-red-50 dark:bg-red-900/40 text-red-500 dark:text-red-300 rounded-xl text-sm font-semibold active:bg-red-100 dark:active:bg-red-900/60">
                <Icon name="trash" size={16} color="#ef4444"/> حذف خانواده
              </button>
            </div>

            {/* Children */}
            {contact.subContacts?.length > 0 ? (
              <div className="space-y-2">
                {contact.subContacts.map(child => (
                  <Level2Card
                    key={child.id}
                    contact={child}
                    forceOpen={childForceOpen(child)}
                    onUpdatePhoto={b64 => updateChild(child.id, { ...child, image: b64 })}
                    onEdit={data => updateChild(child.id, { ...child, ...data })}
                    onDelete={() => deleteChild(child.id)}
                    onAddChild={gc => addGrandchild(child.id, gc)}
                    onUpdateChild={(gcId, patch) => updateGrandchild(child.id, gcId, patch)}
                    onDeleteChild={gcId => deleteGrandchild(child.id, gcId)}
                  />
                ))}
              </div>
            ) : (
              <div className="py-4 text-center">
                <p className="text-slate-400 dark:text-slate-500 text-sm">هنوز فرزندی اضافه نشده است</p>
                <button onClick={() => setModal({ type:'add-child' })}
                  className="mt-2 text-indigo-500 dark:text-indigo-400 text-sm font-semibold active:text-indigo-600">
                  + افزودن اولین فرزند
                </button>
              </div>
            )}
          </div>
        )}
      </div>

      <ContactModal
        open={modal?.type === 'add-child'}
        initial={null}
        onSave={data => addChild({ id: uid(), name: data.name, phone: data.phone, image: null, subContacts: [] })}
        onClose={() => setModal(null)}
      />
      <ContactModal
        open={modal?.type === 'edit'}
        initial={modal?.initial}
        onSave={data => update(data)}
        onClose={() => setModal(null)}
      />
      <ConfirmDialog
        open={confirm}
        message="تمام اطلاعات این خانواده حذف خواهد شد. مطمئنید؟"
        onConfirm={() => { onDelete(); setConfirm(false); }}
        onCancel={() => setConfirm(false)}
      />
    </div>
  );
};

// ─── Empty State ───────────────────────────────────────────────────────────
const EmptyState = ({ onAdd }) => (
  <div className="flex flex-col items-center justify-center h-full text-center px-8 py-16 fade-in">
    <div className="w-28 h-28 rounded-full bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/40 dark:to-indigo-900/40 flex items-center justify-center mb-6 shadow-inner">
      <Icon name="userPlus" size={52} color="#6366f1"/>
    </div>
    <h2 className="text-2xl font-extrabold text-slate-700 dark:text-slate-200 mb-2">خوش آمدید!</h2>
    <p className="text-slate-400 dark:text-slate-500 text-base leading-relaxed mb-8">
      هنوز هیچ خانواده‌ای ثبت نشده است.<br/>برای شروع، یک خانواده جدید اضافه کنید.
    </p>
    <button
      onClick={onAdd}
      className="flex items-center gap-2 px-8 py-4 bg-indigo-500 text-white rounded-2xl text-lg font-bold shadow-lg active:bg-indigo-600 transition-all"
    >
      <Icon name="plus" size={22} color="white"/>
      افزودن اولین خانواده
    </button>
  </div>
);

// ─── App ───────────────────────────────────────────────────────────────────
const App = () => {
  const [contacts, setContacts] = useState(() => loadContacts());
  const [modal, setModal] = useState(null);
  const [dark, setDark] = useState(() => loadDarkMode());
  const [searchQuery, setSearchQuery] = useState('');
  const [searchOpen, setSearchOpen] = useState(false);
  const [searchVersion, setSearchVersion] = useState(0);
  const searchInputRef = useRef();

  // Apply dark mode class
  useEffect(() => {
    document.documentElement.classList.toggle('dark', dark);
    localStorage.setItem(DM_KEY, dark ? 'true' : 'false');
  }, [dark]);

  useEffect(() => {
    saveContacts(contacts);
  }, [contacts]);

  // When search query changes, increment version to force-open matching cards
  useEffect(() => {
    if (searchQuery) setSearchVersion(v => v + 1);
  }, [searchQuery]);

  const addFamily = (data) => {
    setContacts(prev => [...prev, { id: uid(), name: data.name, phone: data.phone, image: null, subContacts: [] }]);
  };

  const updateFamily = (id, patch) => {
    setContacts(prev => prev.map(c => c.id === id ? patch : c));
  };

  const deleteFamily = (id) => {
    setContacts(prev => prev.filter(c => c.id !== id));
  };

  const filteredContacts = searchQuery
    ? contacts.filter(c => familyMatchesSearch(c, searchQuery))
    : contacts;

  // Determine if a L1 card should be force-opened
  const shouldForceOpen = (family) => {
    if (!searchQuery) return false;
    // If the match is in a child or grandchild, force-open L1
    for (const child of (family.subContacts || [])) {
      if (matchesSearch(child, searchQuery)) return true;
      for (const gc of (child.subContacts || [])) {
        if (matchesSearch(gc, searchQuery)) return true;
      }
    }
    return false;
  };

  return (
    <div className="flex flex-col bg-slate-100 dark:bg-slate-900" style={{height:'100vh', width:'100vw'}}>
      {/* Status Bar */}
      <StatusBar/>

      {/* Header */}
      <div className="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-3 flex items-center justify-between shadow-sm" style={{zIndex:10}}>
        <div className="flex-1 min-w-0">
          <h1 className="text-xl font-extrabold text-slate-800 dark:text-slate-100 leading-tight">دفترچه تماس</h1>
          <p className="text-slate-400 dark:text-slate-500 text-xs mt-0.5">
            {contacts.length > 0 ? `${toPersian(contacts.length)} خانواده ثبت‌شده` : 'مخاطبی ثبت نشده'}
          </p>
        </div>
        <div className="flex items-center gap-2">
          {/* Dark mode toggle */}
          <button
            onClick={() => setDark(d => !d)}
            className="w-10 h-10 rounded-xl flex items-center justify-center bg-slate-100 dark:bg-slate-700 active:bg-slate-200 dark:active:bg-slate-600 transition-colors"
            aria-label="تغییر تم"
          >
            {dark
              ? <Icon name="sun" size={20} color="#fbbf24"/>
              : <Icon name="moon" size={20} color="#64748b"/>
            }
          </button>
          {/* Search toggle */}
          <button
            onClick={() => { setSearchOpen(o => !o); if (!searchOpen) setTimeout(() => searchInputRef.current?.focus(), 100); }}
            className="w-10 h-10 rounded-xl flex items-center justify-center bg-slate-100 dark:bg-slate-700 active:bg-slate-200 dark:active:bg-slate-600 transition-colors"
            aria-label="جستجو"
          >
            <Icon name="search" size={20} color="#64748b"/>
          </button>
          <button
            onClick={() => setModal('add-family')}
            className="flex items-center gap-2 px-4 py-2.5 bg-indigo-500 text-white rounded-2xl font-bold text-sm active:bg-indigo-600 shadow-md transition-all"
          >
            <Icon name="plus" size={18} color="white"/>
            خانواده جدید
          </button>
        </div>
      </div>

      {/* Search Bar */}
      {searchOpen && (
        <div className="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-2 flex items-center gap-3 fade-in">
          <Icon name="search" size={18} color="#94a3b8"/>
          <input
            ref={searchInputRef}
            type="text"
            value={searchQuery}
            onChange={e => setSearchQuery(e.target.value)}
            placeholder="جستجوی نام یا شماره..."
            className="flex-1 bg-transparent text-slate-800 dark:text-slate-100 text-sm focus:outline-none placeholder:text-slate-400 dark:placeholder:text-slate-500"
            style={{userSelect:'text', WebkitUserSelect:'text'}}
          />
          {searchQuery && (
            <button onClick={() => setSearchQuery('')} className="p-1">
              <Icon name="close" size={16} color="#94a3b8"/>
            </button>
          )}
          <button onClick={() => { setSearchOpen(false); setSearchQuery(''); }} className="text-slate-400 dark:text-slate-500 text-xs font-semibold">بستن</button>
        </div>
      )}

      {/* Main Content */}
      <div className="flex-1 scroll-area" style={{minHeight:0}}>
        {contacts.length === 0 ? (
          <EmptyState onAdd={() => setModal('add-family')}/>
        ) : filteredContacts.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-20 text-center fade-in">
            <Icon name="search" size={48} color="#94a3b8"/>
            <p className="text-slate-400 dark:text-slate-500 text-base mt-4">نتیجه‌ای یافت نشد</p>
          </div>
        ) : (
          <div className="p-4 space-y-4 pb-32">
            {filteredContacts.map(contact => (
              <Level1Card
                key={contact.id + '-' + searchVersion}
                contact={contact}
                onChange={patch => updateFamily(contact.id, patch)}
                onDelete={() => deleteFamily(contact.id)}
                forceOpen={shouldForceOpen(contact)}
                searchQuery={searchQuery}
              />
            ))}
          </div>
        )}
      </div>

      {/* Footer SOS */}
      <div className="bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 px-4 py-3 flex items-center justify-center" style={{paddingBottom:'max(0.75rem, env(safe-area-inset-bottom))'}}>
        <a
          href="tel:115"
          className="pulse-sos flex items-center gap-3 px-10 py-4 bg-red-500 text-white rounded-2xl font-extrabold text-xl shadow-xl active:bg-red-600 transition-all"
        >
          <Icon name="alertCircle" size={28} color="white"/>
          اورژانس — ۱۱۵
        </a>
      </div>

      {/* Add Family Modal */}
      <ContactModal
        open={modal === 'add-family'}
        initial={null}
        onSave={addFamily}
        onClose={() => setModal(null)}
      />
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
